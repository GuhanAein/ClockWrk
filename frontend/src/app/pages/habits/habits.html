<div class="habits-container">
    <!-- Header -->
    <header class="habits-header">
        <div class="header-left">
            <button class="back-btn" (click)="goToDashboard()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                Back to Dashboard
            </button>
            <h1 class="page-title">
                <span class="title-icon">üìä</span>
                Habit Sheet
            </h1>
        </div>

        <div class="header-controls">
            <!-- Filter -->
            <div class="control-group">
                <label>Filter:</label>
                <select [(ngModel)]="filterCategory" class="control-select">
                    <option value="All">All Categories</option>
                    <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
                </select>
            </div>

            <!-- Sort -->
            <div class="control-group">
                <label>Sort:</label>
                <select [(ngModel)]="sortBy" class="control-select">
                    <option value="name">Name</option>
                    <option value="streak">Streak</option>
                    <option value="completion">Success %</option>
                </select>
            </div>
        </div>

        <div class="header-right">
            <div class="month-nav">
                <button class="nav-btn" (click)="previousMonth()">‚Üê</button>
                <span class="month-label">{{ getMonthYear() }}</span>
                <button class="nav-btn" (click)="nextMonth()">‚Üí</button>
            </div>
            <button class="add-habit-btn" (click)="openAddHabitModal()">
                + Add Habit
            </button>
            <button class="logout-btn" (click)="logout()">Logout</button>
        </div>
    </header>

    <!-- Sheet View (Scrollable Table) -->
    <div class="sheet-viewport">
        <div class="sheet-table">
            <!-- Header Row -->
            <div class="sheet-row header-row">
                <div class="sheet-cell sticky-col name-col">Habit</div>
                <div class="sheet-cell info-col">Goal</div>
                <div class="sheet-cell info-col">Frequency</div>

                <!-- Day Columns -->
                <div class="sheet-cell day-col" *ngFor="let day of monthDays" [class.today-header]="isToday(day)">
                    <div class="day-number">{{ day.getDate() }}</div>
                    <div class="day-name">{{ weekDays[day.getDay()] }}</div>
                </div>

                <!-- Stats Columns -->
                <div class="sheet-cell stat-col">Monthly</div>
                <div class="sheet-cell stat-col">Streak</div>
                <div class="sheet-cell stat-col">Best</div>
                <div class="sheet-cell stat-col success-col">Success %</div>
            </div>

            <!-- Habit Rows -->
            <div class="sheet-row habit-row" *ngFor="let habit of filteredHabits">
                <div class="sheet-cell sticky-col name-cell" [style.border-left-color]="habit.color">
                    <span class="habit-icon">{{ habit.icon }}</span>
                    <div class="habit-details">
                        <span class="habit-name">{{ habit.name }}</span>
                        <span class="habit-category-badge" [style.background-color]="habit.color + '20'"
                            [style.color]="habit.color">
                            {{ habit.category }}
                        </span>
                    </div>
                    <button class="edit-btn" (click)="openEditHabitModal(habit)">‚úé</button>
                </div>
                <div class="sheet-cell info-cell" title="{{ habit.description }}">{{ habit.description || '-' }}</div>
                <div class="sheet-cell info-cell">{{ habit.frequency | titlecase }}</div>

                <!-- Day Checkboxes -->
                <div class="sheet-cell day-cell" *ngFor="let day of monthDays"
                    [class.weekend]="day.getDay() === 0 || day.getDay() === 6" [class.today]="isToday(day)"
                    [class.future]="isFutureDate(day)" (click)="toggleHabit(habit, day, $event)">
                    <div class="checkbox" [class.checked]="isHabitCompleted(habit.id!, day)"
                        [style.background-color]="isHabitCompleted(habit.id!, day) ? habit.color : 'transparent'"
                        [style.border-color]="isHabitCompleted(habit.id!, day) ? habit.color : '#e2e8f0'">
                        <span *ngIf="isHabitCompleted(habit.id!, day)">‚úì</span>
                    </div>
                </div>

                <!-- Stats Values -->
                <div class="sheet-cell stat-cell">{{ getMonthlyResult(habit) }}</div>
                <div class="sheet-cell stat-cell highlight-stat">{{ habit.stats?.currentStreak || 0 }}</div>
                <div class="sheet-cell stat-cell">{{ habit.stats?.longestStreak || 0 }}</div>
                <div class="sheet-cell stat-cell success-cell">
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" [style.width.%]="getMonthlySuccessPercentage(habit)"
                            [style.background-color]="habit.color"></div>
                    </div>
                    <span class="progress-text">{{ getMonthlySuccessPercentage(habit) }}%</span>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="filteredHabits.length === 0">
                <p>No habits found matching your filter.</p>
                <div *ngIf="habits.length === 0">
                    <p>Start tracking by adding a new habit!</p>
                    <button class="primary-btn" (click)="openAddHabitModal()">Create First Habit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Add/Edit) -->
    <div class="modal-overlay" *ngIf="isAddHabitModalOpen || isEditHabitModalOpen"
        (click)="isAddHabitModalOpen ? closeAddHabitModal() : closeEditHabitModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>{{ isAddHabitModalOpen ? 'Create New Habit' : 'Edit Habit' }}</h2>
                <button class="close-btn"
                    (click)="isAddHabitModalOpen ? closeAddHabitModal() : closeEditHabitModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Habit Name *</label>
                    <input type="text" [(ngModel)]="habitForm.name" placeholder="e.g., Morning Exercise"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>Goal (Description)</label>
                    <input type="text" [(ngModel)]="habitForm.description" placeholder="e.g., Run 5km"
                        class="form-input">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Frequency</label>
                        <select [(ngModel)]="habitForm.frequency" class="form-select">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select [(ngModel)]="habitForm.category" class="form-select">
                            <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Icon</label>
                    <div class="icon-picker">
                        <button type="button" *ngFor="let icon of icons" class="icon-option"
                            [class.selected]="habitForm.icon === icon" (click)="habitForm.icon = icon">
                            {{ icon }}
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <button type="button" *ngFor="let color of colors" class="color-option"
                            [class.selected]="habitForm.color === color" [style.background-color]="color"
                            (click)="habitForm.color = color">
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="delete-btn" *ngIf="isEditHabitModalOpen && selectedHabit"
                    (click)="deleteHabit(selectedHabit)">Delete</button>
                <div class="spacer"></div>
                <button class="secondary-btn"
                    (click)="isAddHabitModalOpen ? closeAddHabitModal() : closeEditHabitModal()">Cancel</button>
                <button class="primary-btn" (click)="isAddHabitModalOpen ? saveHabit() : updateHabit()">Save</button>
            </div>
        </div>
    </div>
</div>